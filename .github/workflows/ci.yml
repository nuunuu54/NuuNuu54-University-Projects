name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: PowerShell/PowerShell@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module Pester -Scope CurrentUser -Force -SkipPublisherCheck

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force -SkipPublisherCheck

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $files = Get-ChildItem -Path . -Include *.ps1 -Recurse | Select-Object -ExpandProperty FullName
          foreach ($f in $files) { Invoke-ScriptAnalyzer -Path $f -Recurse -Severity Warning }

      - name: Run Pester tests
        shell: pwsh
        run: |
          Invoke-Pester -Path .\Setup-FabrikamServer-Extended.Tests.ps1 -Output Detailed

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pester-results
          path: |
            ./Test_Results.txt
